<!DOCTYPE html>
<html>
  <head>
    <%- include ('../../includes/head') %>
    <title>Book - <%= title %></title>
  </head>
  <body>
    <%- include('../../includes/header') %>
    <div class="sbr-maincontainer">
      <h1><%= title %></h1>
      <table>
        <tr>
          <td>
            <div class="sbr-rating-star">
              <% for (let i=5; i>=1; i--) { %>
                <input type="radio" id="book_rating_<%= i %>" disabled<% if (Math.round(rating)===i) { %> checked<% } %>>
                <label for="book_rating_<%= i %>"></label>
              <% } %>
            </div>
          </td>
          <td>
            <p class="sbr-rating-number"><%= rating %></p>
          </td>
        </tr>
      </table>
      <p></p>
      <button type="button" class="sbr-leave-review-collapse-button" id="leave_review_button" data-bs-toggle="collapse" data-bs-target="#review_form_container" aria-expanded="false" aria-controls="review_form_container">Leave review</button>
      <div class="sbr-leave-review-box collapse" id="review_form_container">
        <form class="sbr-form" id="review_form">
          <div class="sbr-form-field">
            <label class="sbr-form-label">Rating</label>
            <div class="sbr-rating-star sbr-rating-star-dynamic">
              <% for (let i=5; i>=1; i--) { %>
                <input type="radio" name="rating" id="form_rating_<%= i %>">
                <label for="form_rating_<%= i %>"></label>
              <% } %>
            </div>
          </div>
          <div class="sbr-form-field">
            <label for="comment_text_area">Comment</label>
            <textarea class="form-control" id="comment_text_area" rows="3"></textarea>
          </div>
          <button type="submit" class="sbr-form-submit-btn">Submit review</button>
        </form>
        <div id="form_submit_info"></div>
      </div>
      <p></p>
      <h4>Reviews:</h4>
      <% if (userReview != null) { %>
        <div id="user_review" class="collapse show">
          <span class="sbr-review-comment-name-user">Your review</span>
          <a class="sbr-review-comment-user-delete" id="delete_review" href="javascript:void(0)">Delete review</a>
          <div class="sbr-rating-star">
            <% for (let i=5; i>=1; i--) { %>
              <input type="radio" id="user_review_rating_<%= i %>" disabled<% if (Math.round(userReview.rating)===i) { %> checked<% } %>>
              <label for="user_review_rating_<%= i %>"></label>
            <% } %>
          </div>
          <% if (userReview.comment!=null) { %><p><%= userReview.comment %></p><% } %>
          <% if (reviews.length>0) { %><hr><% } %>
          <div id="review_delete_error_info"></div>
        </div>
      <% } %>
      <% for (k in reviews) { %>
        <div>
        <span class="sbr-review-comment-name"><%= reviews[k].name %></span>
        <div class="sbr-rating-star">
          <% for (let i=5; i>=1; i--) { %>
            <input type="radio" id="review_<%= k %>_rating_<%= i %>" disabled<% if (Math.round(reviews[k].rating)===i) { %> checked<% } %>>
            <label for="review_<%= k %>_rating_<%= i %>"></label>
          <% } %>
        </div>
        <% if (reviews[k].comment!=null) { %><p><%= reviews[k].comment %></p><% } %>
        <% if (k+1<reviews.length) { %><hr><% } %>
        </div>
      <% } %>
    </div>
    <%- include('../../includes/footer') %>
    <script>
      function formSubmit(infobox) {
        const isbn = '<%= isbn %>';

        let checkedStar;
        if (document.getElementById('form_rating_1').checked) {
          checkedStar = 1;
        } else if (document.getElementById('form_rating_2').checked) {
          checkedStar = 2;
        } else if (document.getElementById('form_rating_3').checked) {
          checkedStar = 3;
        } else if (document.getElementById('form_rating_4').checked) {
          checkedStar = 4;
        } else if (document.getElementById('form_rating_5').checked) {
          checkedStar = 5;
        } else {
          Common.CommonUI.errorMessage(infobox, 'Please select a rating.');
          return;
        }

        let comment = document.getElementById('comment_text_area').value;
        if (comment === '') {
          comment = null;
        }
        Common.CommonUI.loadingIcon(infobox);

        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            Common.CommonUI.successMessage(infobox, this.responseText);
          } else if (this.readyState == 4) {
            Common.CommonUI.errorMessage(infobox, this.responseText);
          }
        };

        xhttp.open('POST', '<%= config.siteUrl %>/books/post-review/submit/', true);
        xhttp.setRequestHeader('Content-Type', 'application/json');
        const data = {
          isbn: isbn,
          rating: checkedStar,
          comment: comment
        };
        xhttp.send(JSON.stringify(data));
      }
      function deleteReview(ratingBox) {
        ratingBox.classList.add('sbr-review-comment-user-deleting');
        setTimeout(() => {
          new Common.Collapse(ratingBox, {
            hide: true
          });
        }, '1000');
      }
    </script>
    <script>
      document.getElementById('leave_review_button').addEventListener('click', function() {
        if (!Account.Account.checkLogin('<%= config.loggedInCookie %>')) {
          window.location.href = '<%= config.siteUrl %>/account/log-in/';
          return;
        }
      });
    </script>
    <script>
      document.getElementById('review_form').addEventListener('submit', function(event) {
        event.preventDefault();
        formSubmit(document.getElementById('form_submit_info'));
      });
    </script>
    <script>
      document.getElementById('delete_review').addEventListener('click', function(event) {
        deleteReview(document.getElementById('user_review'), 
          document.getElementById('review_delete_error_info'));
      });
    </script>
  </body>
</html>